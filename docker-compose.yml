services:
  # PostgreSQL Database
  postgres:
    image: postgres:17.6-alpine
    container_name: postgres-elicitation
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_DB=elicitation_ai
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Ollama service (Local LLM)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama-service
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  elicitation-ai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: svc-elicitation-ai
    ports:
      - "8002:8002"
    environment:
      # Application
      - APP_ENV=${APP_ENV:-development}
      - APP_PORT=8002
      - APP_HOST=0.0.0.0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # CORS
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
      
      # Backend PHP Service
      - BACKEND_PHP_URL=${BACKEND_PHP_URL:-http://host.docker.internal:8000/api/v1}
      
      # Database
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/elicitation_ai
      - DB_POOL_SIZE=${DB_POOL_SIZE:-20}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-10}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-3600}
      
      # Authentication Service
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://host.docker.internal:8001}
      - JWT_ISSUER=${JWT_ISSUER:-https://api.example.com}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-https://api.example.com}
      - JWKS_CACHE_TTL=${JWKS_CACHE_TTL:-3600}
      
      # Model Provider (local or openai)
      - MODEL_PROVIDER=${MODEL_PROVIDER:-local}
      
      # OpenAI (only if MODEL_PROVIDER=openai)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      
      # Ollama (only if MODEL_PROVIDER=local)
      # Use the service name as hostname
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=llama3.2:3b
      
      # Interview Configuration
      - MIN_QUESTIONS=${MIN_QUESTIONS:-7}
      - MAX_QUESTIONS=${MAX_QUESTIONS:-20}
    
    volumes:
      # Mount data directory for mock users
      - ./data:/app/data:ro
    
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_healthy
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8002/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Volumes for persistent data
volumes:
  postgres-data:
    driver: local
  ollama-data:
    driver: local

# Networks configuration (optional)
# Uncomment if you need to connect this service with other Docker services
# networks:
#   tesis-network:
#     driver: bridge

# Usage:
# 1. Start services:
#    docker-compose up -d
#
# 2. Pull Ollama model (first time only):
#    docker exec -it ollama-service ollama pull llama3.2:3b
#
# 3. Run database migrations (first time only):
#    docker exec -it svc-elicitation-ai python -m alembic upgrade head
#
# 4. View logs:
#    docker-compose logs -f elicitation-ai
#    docker-compose logs -f ollama
#    docker-compose logs -f postgres
#
# 5. Stop services:
#    docker-compose down
#
# 6. Stop and remove volumes (WARNING: deletes Ollama models and database data):
#    docker-compose down -v
