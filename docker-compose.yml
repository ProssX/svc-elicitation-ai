services:
  postgres:
    image: postgres:17.6-alpine
    container_name: postgres-elicitation
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_DB=elicitation_ai
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: redis-elicitation
    ports:
      - "6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  elicitation-ai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: svc-elicitation-ai
    ports:
      - "8002:8002"
    environment:
      # Application
      - APP_ENV=${APP_ENV:-development}
      - APP_PORT=8002
      - APP_HOST=0.0.0.0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # CORS
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
      
      # Backend PHP Service
      - BACKEND_PHP_URL=${BACKEND_PHP_URL:-http://host.docker.internal:8000/api/v1}
      
      # Database
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/elicitation_ai
      - DB_POOL_SIZE=${DB_POOL_SIZE:-20}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-10}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-3600}
      
      # Authentication Service
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://host.docker.internal:8001}
      - JWT_ISSUER=${JWT_ISSUER:-https://api.example.com}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-https://api.example.com}
      - JWKS_CACHE_TTL=${JWKS_CACHE_TTL:-3600}
      
      # Model Provider (local or openai)
      - MODEL_PROVIDER=${MODEL_PROVIDER:-local}
      
      # OpenAI (only if MODEL_PROVIDER=openai)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      
      # Interview Configuration
      - MIN_QUESTIONS=${MIN_QUESTIONS:-7}
      - MAX_QUESTIONS=${MAX_QUESTIONS:-20}
      
      # Context Enrichment
      - ENABLE_CONTEXT_ENRICHMENT=${ENABLE_CONTEXT_ENRICHMENT:-true}
      - ENABLE_PROCESS_MATCHING=${ENABLE_PROCESS_MATCHING:-true}
      - CONTEXT_CACHE_TTL=${CONTEXT_CACHE_TTL:-300}
      
      # Redis
      - REDIS_URL=redis://redis:6379
      - WORKER_MODE=false
    
    volumes:
      - ./data:/app/data:ro
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8002/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  elicitation-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: svc-elicitation-worker
    command: python -m app.workers.process_extraction_worker
    environment:
      - APP_ENV=${APP_ENV:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/elicitation_ai
      - BACKEND_PHP_URL=${BACKEND_PHP_URL:-http://host.docker.internal:8000/api/v1}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://host.docker.internal:8001}
      - REDIS_URL=redis://redis:6379
      - WORKER_MODE=true
      - MODEL_PROVIDER=${MODEL_PROVIDER:-local}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      elicitation-ai:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres-data:
    driver: local

# Networks configuration
networks:
  default:
    name: svc-users-python_svc-users-network
    external: true